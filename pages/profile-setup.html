<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finaliser votre profil - FORNAP</title>
    
    <!-- CSS -->
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/components.css">
</head>
<body>
    <!-- Placeholder pour la navbar - sera remplac√©e par le composant -->
    <div id="navbar-placeholder"></div>

    <!-- ========================================
         CONTENU PRINCIPAL
         ======================================== -->
    <main class="main-content">
        
        <!-- Section Hero -->
        <section class="hero">
            <div class="container">
                <h1>Finaliser votre profil FORNAP</h1>
                <p>Quelques informations suppl√©mentaires pour personnaliser votre exp√©rience membre</p>
                
                <!-- Barre de progression -->
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-steps">
                        <div class="progress-step active" id="step1">
                            <span class="step-number">1</span>
                            <span class="step-label">Informations personnelles</span>
                        </div>
                        <div class="progress-step" id="step2">
                            <span class="step-number">2</span>
                            <span class="step-label">Pr√©f√©rences</span>
                        </div>
                        <div class="progress-step" id="step3">
                            <span class="step-number">3</span>
                            <span class="step-label">Communication</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section Formulaire -->
        <section class="form-section">
            <div class="container">
                <div class="form-container">
                    
                    <!-- √âtape 1: Informations personnelles -->
                    <div class="form-step active" id="formStep1">
                        <div class="step-header">
                            <h2>Informations personnelles</h2>
                            <p>Ces informations nous aident √† personnaliser votre exp√©rience</p>
                        </div>

                        <div class="form-content">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="firstName">Pr√©nom *</label>
                                    <input type="text" id="firstName" class="form-input" required placeholder="Jean">
                                </div>
                                
                                <div class="form-group">
                                    <label for="lastName">Nom *</label>
                                    <input type="text" id="lastName" class="form-input" required placeholder="Dupont">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="phone">T√©l√©phone</label>
                                    <input type="tel" id="phone" class="form-input" placeholder="06 12 34 56 78">
                                </div>
                                
                                <div class="form-group">
                                    <label for="birthDate">Date de naissance</label>
                                    <input type="date" id="birthDate" class="form-input">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="postalCode">Code postal</label>
                                    <input type="text" id="postalCode" class="form-input" placeholder="75001" maxlength="5" pattern="[0-9]{5}">
                                </div>
                                
                                <div class="form-group">
                                    <label for="profession">Profession</label>
                                    <select id="profession" class="form-select">
                                        <option value="">Choisir...</option>
                                        <option value="freelance">Freelance / Ind√©pendant</option>
                                        <option value="entrepreneur">Entrepreneur</option>
                                        <option value="salarie">Salari√©</option>
                                        <option value="etudiant">√âtudiant</option>
                                        <option value="developer">D√©veloppeur</option>
                                        <option value="designer">Designer</option>
                                        <option value="marketing">Marketing / Communication</option>
                                        <option value="consultant">Consultant</option>
                                        <option value="commercial">Commercial</option>
                                        <option value="finance">Finance / Comptabilit√©</option>
                                        <option value="juridique">Juridique</option>
                                        <option value="sante">Sant√©</option>
                                        <option value="education">√âducation</option>
                                        <option value="art">Arts / Culture</option>
                                        <option value="autre">Autre</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="company">Entreprise / Organisation (optionnel)</label>
                                <input type="text" id="company" class="form-input" placeholder="Nom de votre entreprise">
                            </div>
                        </div>

                        <div class="step-actions">
                            <button type="button" class="btn btn-primary" onclick="nextStep(2)">
                                Continuer
                            </button>
                        </div>
                    </div>

                    <!-- √âtape 2: Pr√©f√©rences -->
                    <div class="form-step" id="formStep2">
                        <div class="step-header">
                            <h2>Vos pr√©f√©rences</h2>
                            <p>Aidez-nous √† vous proposer du contenu et des √©v√©nements qui vous int√©ressent</p>
                        </div>

                        <div class="form-content">
                            <div class="form-group">
                                <label>Centres d'int√©r√™t (s√©lectionner tout ce qui vous int√©resse)</label>
                                <div class="interest-grid">
                                    <label class="interest-item">
                                        <input type="checkbox" name="interests" value="networking">
                                        <span class="interest-label">ü§ù Networking</span>
                                    </label>
                                    
                                    <label class="interest-item">
                                        <input type="checkbox" name="interests" value="tech">
                                        <span class="interest-label">üíª Technologie</span>
                                    </label>
                                    
                                    <label class="interest-item">
                                        <input type="checkbox" name="interests" value="design">
                                        <span class="interest-label">üé® Design</span>
                                    </label>
                                    
                                    <label class="interest-item">
                                        <input type="checkbox" name="interests" value="startup">
                                        <span class="interest-label">üöÄ Startups</span>
                                    </label>
                                    
                                    <label class="interest-item">
                                        <input type="checkbox" name="interests" value="marketing">
                                        <span class="interest-label">üìà Marketing</span>
                                    </label>
                                    
                                    <label class="interest-item">
                                        <input type="checkbox" name="interests" value="finance">
                                        <span class="interest-label">üí∞ Finance</span>
                                    </label>
                                    
                                    <label class="interest-item">
                                        <input type="checkbox" name="interests" value="art">
                                        <span class="interest-label">üé≠ Arts & Culture</span>
                                    </label>
                                    
                                    <label class="interest-item">
                                        <input type="checkbox" name="interests" value="wellness">
                                        <span class="interest-label">üßò Bien-√™tre</span>
                                    </label>
                                    
                                    <label class="interest-item">
                                        <input type="checkbox" name="interests" value="formation">
                                        <span class="interest-label">üìö Formation</span>
                                    </label>
                                    
                                    <label class="interest-item">
                                        <input type="checkbox" name="interests" value="sustainability">
                                        <span class="interest-label">üå± D√©veloppement durable</span>
                                    </label>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="workingStyle">Style de travail pr√©f√©r√©</label>
                                <select id="workingStyle" class="form-select">
                                    <option value="">Choisir...</option>
                                    <option value="quiet">Environnement calme</option>
                                    <option value="collaborative">Espaces collaboratifs</option>
                                    <option value="flexible">Flexible selon les projets</option>
                                    <option value="private">Espaces priv√©s</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="visitFrequency">Fr√©quence de visite pr√©vue</label>
                                <select id="visitFrequency" class="form-select">
                                    <option value="">Choisir...</option>
                                    <option value="daily">Quotidienne</option>
                                    <option value="few-times-week">Plusieurs fois par semaine</option>
                                    <option value="weekly">Hebdomadaire</option>
                                    <option value="monthly">Mensuelle</option>
                                    <option value="occasionally">Occasionnelle</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="motivations">Qu'est-ce qui vous motive le plus chez FORNAP ?</label>
                                <textarea id="motivations" class="form-textarea" rows="4" 
                                          placeholder="Partagez ce qui vous attire dans notre communaut√©..."></textarea>
                            </div>
                        </div>

                        <div class="step-actions">
                            <button type="button" class="btn btn-secondary" onclick="previousStep(1)">
                                Retour
                            </button>
                            <button type="button" class="btn btn-primary" onclick="nextStep(3)">
                                Continuer
                            </button>
                        </div>
                    </div>

                    <!-- √âtape 3: Communication -->
                    <div class="form-step" id="formStep3">
                        <div class="step-header">
                            <h2>Pr√©f√©rences de communication</h2>
                            <p>Choisissez comment vous souhaitez rester inform√© des nouveaut√©s FORNAP</p>
                        </div>

                        <div class="form-content">
                            <div class="form-group">
                                <label>Notifications par email</label>
                                <div class="checkbox-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="emailEvents" checked>
                                        <span class="checkmark"></span>
                                        √âv√©nements et ateliers
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="emailNews">
                                        <span class="checkmark"></span>
                                        Newsletter mensuelle
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="emailOffers">
                                        <span class="checkmark"></span>
                                        Offres sp√©ciales et promotions
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="emailCommunity">
                                        <span class="checkmark"></span>
                                        Actualit√©s de la communaut√©
                                    </label>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="communicationFrequency">Fr√©quence des communications</label>
                                <select id="communicationFrequency" class="form-select">
                                    <option value="realtime">En temps r√©el</option>
                                    <option value="daily">R√©sum√© quotidien</option>
                                    <option value="weekly" selected>R√©sum√© hebdomadaire</option>
                                    <option value="monthly">R√©sum√© mensuel</option>
                                    <option value="minimal">Communications essentielles uniquement</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Canaux de communication pr√©f√©r√©s</label>
                                <div class="checkbox-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="channelEmail" checked>
                                        <span class="checkmark"></span>
                                        üìß Email
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="channelSMS">
                                        <span class="checkmark"></span>
                                        üì± SMS (√©v√©nements urgents)
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="channelApp">
                                        <span class="checkmark"></span>
                                        üîî Notifications app (√† venir)
                                    </label>
                                </div>
                            </div>

                            <div class="privacy-notice">
                                <h4>üîí Confidentialit√©</h4>
                                <p>Vos donn√©es sont trait√©es conform√©ment √† notre <a href="#" target="_blank">politique de confidentialit√©</a>. 
                                   Vous pouvez modifier ces pr√©f√©rences √† tout moment depuis votre dashboard membre.</p>
                            </div>
                        </div>

                        <div class="step-actions">
                            <button type="button" class="btn btn-secondary" onclick="previousStep(2)">
                                Retour
                            </button>
                            <button type="button" class="btn btn-primary" id="finalizeProfile">
                                Finaliser mon profil
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Placeholder pour le footer - sera remplac√© par le composant -->
    <div id="footer-placeholder"></div>

    <!-- ========================================
         MODAL DE CHARGEMENT
         ======================================== -->
    <div id="loadingModal" class="modal hidden">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="loading-content">
                <div class="loading-spinner"></div>
                <h3 id="loadingTitle">Finalisation de votre profil...</h3>
                <p id="loadingMessage">Veuillez patienter pendant que nous configurons votre espace membre</p>
            </div>
        </div>
    </div>

    <!-- ========================================
         CONTAINER MESSAGES
         ======================================== -->
    <div id="messageContainer"></div>

    <!-- ========================================
         SCRIPTS FIREBASE
         ======================================== -->
    <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore-compat.js"></script>

    <!-- ========================================
         JAVASCRIPT PRINCIPAL
         ======================================== -->
    <script>
        console.log('üìã FORNAP - Profile Setup');

        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyALz161yfiLaOeHU82DQNJV4PkzAXO1wzM",
            authDomain: "nap-7aa80.firebaseapp.com",
            projectId: "nap-7aa80",
            storageBucket: "nap-7aa80.firebasestorage.app",
            messagingSenderId: "434731738248",
            appId: "1:434731738248:web:481644f3a6e809c06d2b3d",
            measurementId: "G-3HVC6HNG02"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        console.log('‚úÖ Firebase initialis√©');

        // Variables globales
        let currentUser = null;
        let currentStep = 1;
        let profileData = {
            personal: {},
            preferences: {},
            communication: {}
        };

        // Fonctions utilitaires
        function showMessage(message, type = 'info') {
            console.log('üí¨ Message:', message, type);
            
            const container = document.getElementById('messageContainer');
            const messageElement = document.createElement('div');
            messageElement.className = `message ${type}`;
            messageElement.textContent = message;
            container.appendChild(messageElement);

            setTimeout(() => messageElement.classList.add('show'), 100);
            setTimeout(() => {
                messageElement.classList.remove('show');
                setTimeout(() => messageElement.remove(), 300);
            }, 4000);
        }

        function showLoadingModal(title, message) {
            document.getElementById('loadingTitle').textContent = title;
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('loadingModal').classList.remove('hidden');
        }

        function hideLoadingModal() {
            document.getElementById('loadingModal').classList.add('hidden');
        }

        function updateProgressBar() {
            const progressFill = document.getElementById('progressFill');
            const progress = (currentStep / 3) * 100;
            progressFill.style.width = `${progress}%`;
        }

        function updateStepIndicators() {
            // R√©initialiser tous les steps
            document.querySelectorAll('.progress-step').forEach(step => {
                step.classList.remove('active', 'completed');
            });

            // Marquer les steps compl√©t√©s et actifs
            for (let i = 1; i <= 3; i++) {
                const step = document.getElementById(`step${i}`);
                if (i < currentStep) {
                    step.classList.add('completed');
                } else if (i === currentStep) {
                    step.classList.add('active');
                }
            }
        }

        function showStep(stepNumber) {
            // Cacher toutes les √©tapes
            document.querySelectorAll('.form-step').forEach(step => {
                step.classList.remove('active');
            });

            // Afficher l'√©tape actuelle
            document.getElementById(`formStep${stepNumber}`).classList.add('active');

            // Mettre √† jour les indicateurs
            currentStep = stepNumber;
            updateProgressBar();
            updateStepIndicators();
        }

        function validateStep1() {
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();

            if (!firstName || !lastName) {
                showMessage('Veuillez remplir au minimum votre pr√©nom et nom', 'error');
                return false;
            }

            // Validation du code postal
            const postalCode = document.getElementById('postalCode').value.trim();
            if (postalCode && !/^[0-9]{5}$/.test(postalCode)) {
                showMessage('Le code postal doit contenir 5 chiffres', 'error');
                return false;
            }

            return true;
        }

        function validateStep2() {
            // Les pr√©f√©rences sont optionnelles, mais on peut v√©rifier qu'au moins un int√©r√™t est s√©lectionn√©
            const interests = document.querySelectorAll('input[name="interests"]:checked');
            if (interests.length === 0) {
                const confirmContinue = confirm('Aucun centre d\'int√©r√™t s√©lectionn√©. Continuer quand m√™me ?');
                return confirmContinue;
            }
            return true;
        }

        function collectStepData(stepNumber) {
            if (stepNumber === 1) {
                // Informations personnelles
                profileData.personal = {
                    firstName: document.getElementById('firstName').value.trim(),
                    lastName: document.getElementById('lastName').value.trim(),
                    phone: document.getElementById('phone').value.trim(),
                    birthDate: document.getElementById('birthDate').value,
                    postalCode: document.getElementById('postalCode').value.trim(),
                    profession: document.getElementById('profession').value,
                    company: document.getElementById('company').value.trim()
                };

                // Calculer l'√¢ge si date de naissance fournie
                if (profileData.personal.birthDate) {
                    const birthDate = new Date(profileData.personal.birthDate);
                    const today = new Date();
                    const age = today.getFullYear() - birthDate.getFullYear();
                    const monthDiff = today.getMonth() - birthDate.getMonth();
                    
                    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                        profileData.personal.age = age - 1;
                    } else {
                        profileData.personal.age = age;
                    }
                }

            } else if (stepNumber === 2) {
                // Pr√©f√©rences
                const interests = [];
                document.querySelectorAll('input[name="interests"]:checked').forEach(checkbox => {
                    interests.push(checkbox.value);
                });

                profileData.preferences = {
                    interests: interests,
                    workingStyle: document.getElementById('workingStyle').value,
                    visitFrequency: document.getElementById('visitFrequency').value,
                    motivations: document.getElementById('motivations').value.trim()
                };

            } else if (stepNumber === 3) {
                // Communication
                profileData.communication = {
                    emailNotifications: {
                        events: document.getElementById('emailEvents').checked,
                        newsletter: document.getElementById('emailNews').checked,
                        offers: document.getElementById('emailOffers').checked,
                        community: document.getElementById('emailCommunity').checked
                    },
                    frequency: document.getElementById('communicationFrequency').value,
                    preferredChannels: {
                        email: document.getElementById('channelEmail').checked,
                        sms: document.getElementById('channelSMS').checked,
                        app: document.getElementById('channelApp').checked
                    }
                };
            }

            console.log(`üìä Donn√©es √©tape ${stepNumber} collect√©es:`, 
                stepNumber === 1 ? profileData.personal : 
                stepNumber === 2 ? profileData.preferences : 
                profileData.communication);
        }

        function nextStep(targetStep) {
            // Valider l'√©tape actuelle
            let isValid = true;
            
            if (currentStep === 1) {
                isValid = validateStep1();
            } else if (currentStep === 2) {
                isValid = validateStep2();
            }

            if (!isValid) return;

            // Collecter les donn√©es de l'√©tape actuelle
            collectStepData(currentStep);

            // Passer √† l'√©tape suivante
            showStep(targetStep);
            
            // Faire d√©filer vers le haut
            document.querySelector('.form-section').scrollIntoView({ behavior: 'smooth' });
        }

        function previousStep(targetStep) {
            // Collecter les donn√©es de l'√©tape actuelle (sans validation)
            collectStepData(currentStep);
            
            // Retourner √† l'√©tape pr√©c√©dente
            showStep(targetStep);
            
            // Faire d√©filer vers le haut
            document.querySelector('.form-section').scrollIntoView({ behavior: 'smooth' });
        }

        async function finalizeProfile() {
            console.log('üéØ Finalisation du profil');

            // Collecter les donn√©es de la derni√®re √©tape
            collectStepData(3);

            if (!currentUser) {
                showMessage('Erreur: utilisateur non connect√©', 'error');
                return;
            }

            showLoadingModal('Finalisation en cours...', 'Sauvegarde de votre profil personnalis√©');

            try {
                // R√©cup√©rer les donn√©es de membership stock√©es
                const membershipData = JSON.parse(sessionStorage.getItem('membershipData') || '{}');
                const selectedPlan = JSON.parse(sessionStorage.getItem('selectedPlan') || '{}');

                // Structurer les donn√©es finales pour Firebase
                const finalUserData = {
                    // Informations de base
                    email: currentUser.email,
                    uid: currentUser.uid,
                    createdAt: firebase.firestore.Timestamp.now(),
                    updatedAt: firebase.firestore.Timestamp.now(),
                    
                    // Informations personnelles
                    profile: {
                        firstName: profileData.personal.firstName,
                        lastName: profileData.personal.lastName,
                        phone: profileData.personal.phone || null,
                        birthDate: profileData.personal.birthDate || null,
                        age: profileData.personal.age || null,
                        postalCode: profileData.personal.postalCode || null,
                        profession: profileData.personal.profession || null,
                        company: profileData.personal.company || null
                    },
                    
                    // Abonnement structur√©
                    subscription: {
                        type: selectedPlan.level || 'monthly', // monthly, yearly, honor
                        name: selectedPlan.name || 'Membre Mensuel',
                        amount: selectedPlan.amount || selectedPlan.price || 0,
                        period: selectedPlan.period || '/mois',
                        loyaltyEnabled: selectedPlan.loyaltyEnabled || false,
                        startDate: firebase.firestore.Timestamp.now(),
                        status: 'active',
                        features: selectedPlan.features || []
                    },
                    
                    // Adh√©sion
                    membership: {
                        number: `FORNAP-${Date.now()}`,
                        startDate: new Date().toLocaleDateString('fr-FR'),
                        status: 'active',
                        ...membershipData
                    },
                    
                    // Programme de fid√©lit√©
                    loyalty: {
                        points: 0,
                        tier: 'bronze',
                        totalEarned: 0,
                        totalSpent: 0,
                        transactions: []
                    },
                    
                    // Pr√©f√©rences utilisateur
                    preferences: {
                        interests: profileData.preferences.interests || [],
                        workingStyle: profileData.preferences.workingStyle || null,
                        visitFrequency: profileData.preferences.visitFrequency || null,
                        motivations: profileData.preferences.motivations || null
                    },
                    
                    // Pr√©f√©rences de communication
                    communication: {
                        emailNotifications: profileData.communication.emailNotifications || {},
                        frequency: profileData.communication.frequency || 'weekly',
                        preferredChannels: profileData.communication.preferredChannels || {}
                    },
                    
                    // Statistiques d'utilisation
                    usage: {
                        coworkingHours: 0,
                        eventsAttended: 0,
                        lastVisit: null,
                        totalVisits: 0
                    }
                };

                console.log('üíæ Donn√©es finales √† sauvegarder:', finalUserData);

                // Sauvegarder dans Firebase
                await db.collection('members').doc(currentUser.uid).set(finalUserData);

                // Sauvegarder temporairement dans sessionStorage pour le dashboard
                sessionStorage.setItem('profileData', JSON.stringify(profileData));
                sessionStorage.setItem('userProfile', JSON.stringify(finalUserData.profile));

                hideLoadingModal();
                showMessage('Profil finalis√© avec succ√®s !', 'success');

                console.log('‚úÖ Profil sauvegard√© avec succ√®s');

                // Redirection vers la page de f√©licitations
                setTimeout(() => {
                    window.location.href = 'congratulations.html';
                }, 1500);

            } catch (error) {
                console.error('‚ùå Erreur lors de la finalisation:', error);
                hideLoadingModal();
                showMessage('Erreur lors de la sauvegarde. Veuillez r√©essayer.', 'error');
            }
        }

        async function handleLogout() {
            try {
                await auth.signOut();
                console.log('‚úÖ D√©connexion r√©ussie');
                showMessage('D√©connexion r√©ussie', 'success');
                
                sessionStorage.clear();
                
                setTimeout(() => {
                                                window.location.href = '../index.html';
                }, 1500);
                
            } catch (error) {
                console.error('‚ùå Erreur d√©connexion:', error);
                showMessage('Erreur lors de la d√©connexion', 'error');
            }
        }

        // Pr√©-remplir les champs si des donn√©es existent
        function displayMembershipInfo() {
            const membershipData = sessionStorage.getItem('membershipData');
            const selectedPlan = sessionStorage.getItem('selectedPlan');
            
            if (membershipData || selectedPlan) {
                const data = membershipData ? JSON.parse(membershipData) : JSON.parse(selectedPlan);
                
                // Cr√©er une belle banni√®re d'information
                const existingBanner = document.querySelector('.membership-banner');
                if (!existingBanner) {
                    const banner = document.createElement('div');
                    banner.className = 'membership-banner';
                    banner.innerHTML = `
                        <div class="banner-content">
                            <div class="banner-icon">üéâ</div>
                            <div class="banner-text">
                                <h4>F√©licitations ! Votre abonnement ${data.planName || data.name} est activ√©</h4>
                                <p>Finalisez maintenant votre profil pour personnaliser votre exp√©rience FORNAP</p>
                            </div>
                            <div class="banner-price">
                                <span class="price">${data.planPrice || data.price}‚Ç¨${data.period || '/mois'}</span>
                            </div>
                        </div>
                    `;
                    
                    // Ins√©rer apr√®s la section hero
                    const heroSection = document.querySelector('.hero');
                    if (heroSection) {
                        heroSection.after(banner);
                    }
                }
            }
        }

        function prefillFormData() {
            // R√©cup√©rer les donn√©es stock√©es
            const storedProfile = sessionStorage.getItem('profileData');
            const userProfile = sessionStorage.getItem('userProfile');
            
            if (storedProfile) {
                const data = JSON.parse(storedProfile);
                profileData = data;
                
                // Pr√©-remplir les champs
                if (data.personal) {
                    Object.keys(data.personal).forEach(key => {
                        const input = document.getElementById(key);
                        if (input && data.personal[key]) {
                            input.value = data.personal[key];
                        }
                    });
                }
                
                if (data.preferences) {
                    // Pr√©-remplir les centres d'int√©r√™t
                    if (data.preferences.interests) {
                        data.preferences.interests.forEach(interest => {
                            const checkbox = document.querySelector(`input[name="interests"][value="${interest}"]`);
                            if (checkbox) checkbox.checked = true;
                        });
                    }
                }
            }
            
            if (userProfile) {
                const userData = JSON.parse(userProfile);
                Object.keys(userData).forEach(key => {
                    const input = document.getElementById(key);
                    if (input && userData[key]) {
                        input.value = userData[key];
                    }
                });
            }
        }

        // V√©rifier les donn√©es de paiement avant l'authentification
        function verifyPaymentData() {
            const paymentData = sessionStorage.getItem('paymentData');
            const membershipData = sessionStorage.getItem('membershipData');
            
            if (!paymentData && !membershipData) {
                console.log('‚ö†Ô∏è Aucune donn√©e de paiement trouv√©e');
                showMessage('Acc√®s non autoris√©. Veuillez d\'abord souscrire un abonnement.', 'error');
                setTimeout(() => window.location.href = '../pages/membership.html', 3000);
                return false;
            }
            
            console.log('‚úÖ Donn√©es de paiement v√©rifi√©es');
            return true;
        }

        // Gestion de l'authentification
        auth.onAuthStateChanged(function(user) {
            console.log('Changement √©tat auth:', user ? user.email : 'd√©connect√©');
            currentUser = user;
            
            // V√©rifier d'abord les donn√©es de paiement
            if (!verifyPaymentData()) {
                return;
            }
            
            if (!user) {
                console.log('‚ö†Ô∏è Utilisateur non connect√©');
                showMessage('Veuillez vous connecter pour finaliser votre profil.', 'warning');
                setTimeout(() => window.location.href = 'payment.html', 3000);
            } else {
                // Pr√©-remplir les donn√©es disponibles
                if (user.email) {
                    profileData.personal.email = user.email;
                }
                prefillFormData();
                
                // Afficher les informations du forfait s√©lectionn√©
                displayMembershipInfo();
            }
        });

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            console.log('‚úÖ DOM charg√© - Profile Setup');

            // √âv√©nements
            document.getElementById('logoutBtn')?.addEventListener('click', handleLogout);
            document.getElementById('finalizeProfile')?.addEventListener('click', finalizeProfile);

            // Initialiser l'affichage
            showStep(1);

            console.log('üìã FORNAP Profile Setup pr√™t !');
        });
    </script>

    <style>
        /* Styles sp√©cifiques au profile setup */
        .logo-img {
            height: 40px;
            width: auto;
            cursor: pointer;
        }

        .progress-container {
            max-width: 800px;
            margin: var(--space-8) auto 0;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: var(--gris-clair);
            border: 2px solid var(--noir-principal);
            margin-bottom: var(--space-6);
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--noir-principal);
            transition: width 0.5s ease;
            width: 33.33%;
        }

        .progress-steps {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-4);
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: var(--space-3);
            transition: var(--transition-base);
        }

        .step-number {
            width: 40px;
            height: 40px;
            border: 2px solid var(--gris-clair);
            background-color: var(--blanc-principal);
            color: var(--gris-moyen);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: var(--font-bold);
            margin-bottom: var(--space-2);
            transition: var(--transition-base);
        }

        .step-label {
            font-size: var(--text-sm);
            color: var(--gris-moyen);
            font-weight: var(--font-medium);
        }

        .progress-step.active .step-number {
            background-color: var(--noir-principal);
            color: var(--blanc-principal);
            border-color: var(--noir-principal);
        }

        .progress-step.active .step-label {
            color: var(--noir-principal);
        }

        .progress-step.completed .step-number {
            background-color: var(--succes);
            color: var(--blanc-principal);
            border-color: var(--succes);
        }

        .progress-step.completed .step-number::after {
            content: '‚úì';
        }

        .progress-step.completed .step-label {
            color: var(--succes);
        }

        .form-step {
            display: none;
        }

        .form-step.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        .step-header {
            text-align: center;
            margin-bottom: var(--space-8);
        }

        .step-header h2 {
            margin-bottom: var(--space-3);
            color: var(--noir-principal);
        }

        .step-header p {
            color: var(--gris-moyen);
            font-size: var(--text-lg);
        }

        .form-content {
            margin-bottom: var(--space-8);
        }

        .step-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: var(--space-6);
            border-top: 2px solid var(--gris-clair);
        }

        .step-actions .btn {
            min-width: 140px;
        }

        /* Grille des centres d'int√©r√™t */
        .interest-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-3);
            margin-top: var(--space-4);
        }

        .interest-item {
            display: flex;
            align-items: center;
            padding: var(--space-3);
            border: 2px solid var(--gris-clair);
            background-color: var(--blanc-principal);
            cursor: pointer;
            transition: var(--transition-base);
        }

        .interest-item:hover {
            border-color: var(--noir-principal);
            background-color: var(--gris-tres-clair);
        }

        .interest-item input[type="checkbox"] {
            margin-right: var(--space-3);
        }

        .interest-item input[type="checkbox"]:checked + .interest-label {
            font-weight: var(--font-bold);
            color: var(--noir-principal);
        }

        .interest-item:has(input:checked) {
            border-color: var(--noir-principal);
            background-color: var(--noir-principal);
            color: var(--blanc-principal);
        }

        .interest-item:has(input:checked) .interest-label {
            color: var(--blanc-principal);
        }

        .interest-label {
            font-size: var(--text-sm);
            color: var(--gris-moyen);
        }

        /* Notice de confidentialit√© */
        .privacy-notice {
            background-color: var(--gris-tres-clair);
            border: 2px solid var(--gris-clair);
            padding: var(--space-4);
            margin-top: var(--space-6);
        }

        .privacy-notice h4 {
            margin-bottom: var(--space-2);
            color: var(--noir-principal);
            font-size: var(--text-base);
        }

        .privacy-notice p {
            font-size: var(--text-sm);
            color: var(--gris-moyen);
            margin: 0;
            line-height: 1.5;
        }

        .privacy-notice a {
            color: var(--noir-principal);
            text-decoration: underline;
        }

        /* Checkbox custom styling */
        .checkbox-label {
            position: relative;
            display: flex;
            align-items: center;
            cursor: pointer;
            margin-bottom: var(--space-2);
            padding-left: var(--space-6);
        }

        .checkbox-label input[type="checkbox"] {
            position: absolute;
            left: 0;
            opacity: 0;
            cursor: pointer;
        }

        .checkmark {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            height: 18px;
            width: 18px;
            background-color: var(--blanc-principal);
            border: 2px solid var(--gris-clair);
            transition: var(--transition-base);
        }

        .checkbox-label:hover .checkmark {
            border-color: var(--noir-principal);
        }

        .checkbox-label input:checked ~ .checkmark {
            background-color: var(--noir-principal);
            border-color: var(--noir-principal);
        }

        .checkmark:after {
            content: "";
            position: absolute;
            display: none;
            left: 5px;
            top: 1px;
            width: 4px;
            height: 8px;
            border: solid var(--blanc-principal);
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        .checkbox-label input:checked ~ .checkmark:after {
            display: block;
        }

        /* Banni√®re d'information membership */
        .membership-banner {
            background: linear-gradient(135deg, var(--noir-principal) 0%, #333 100%);
            color: var(--blanc-principal);
            padding: var(--space-6) 0;
            border-top: 4px solid var(--succes);
            border-bottom: 4px solid var(--succes);
            margin-bottom: var(--space-8);
            animation: slideInDown 0.8s ease;
        }

        .banner-content {
            display: flex;
            align-items: center;
            gap: var(--space-6);
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 var(--space-4);
        }

        .banner-icon {
            font-size: var(--text-4xl);
            animation: bounce 2s infinite;
        }

        .banner-text {
            flex: 1;
        }

        .banner-text h4 {
            color: var(--blanc-principal);
            font-size: var(--text-lg);
            margin-bottom: var(--space-2);
            font-weight: var(--font-bold);
        }

        .banner-text p {
            color: var(--gris-clair);
            margin: 0;
            font-size: var(--text-base);
        }

        .banner-price {
            background: var(--succes);
            color: var(--blanc-principal);
            padding: var(--space-3) var(--space-6);
            border: 2px solid var(--blanc-principal);
            font-weight: var(--font-bold);
            font-size: var(--text-lg);
        }

        /* Animations */
        @keyframes slideInDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% {
                animation-timing-function: cubic-bezier(0.215, 0.610, 0.355, 1.000);
                transform: translate3d(0, 0, 0);
            }
            40%, 43% {
                animation-timing-function: cubic-bezier(0.755, 0.050, 0.855, 0.060);
                transform: translate3d(0, -10px, 0);
            }
            70% {
                animation-timing-function: cubic-bezier(0.755, 0.050, 0.855, 0.060);
                transform: translate3d(0, -5px, 0);
            }
            90% {
                transform: translate3d(0, -2px, 0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Am√©lioration de l'apparence g√©n√©rale */
        .hero {
            background: linear-gradient(135deg, var(--blanc-principal) 0%, var(--gris-tres-clair) 100%);
            position: relative;
            overflow: hidden;
        }

        .hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="20" cy="20" r="1" fill="%23000" opacity="0.1"/><circle cx="80" cy="80" r="1" fill="%23000" opacity="0.1"/><circle cx="40" cy="60" r="1" fill="%23000" opacity="0.05"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>') repeat;
            opacity: 0.3;
            pointer-events: none;
        }

        .hero h1 {
            position: relative;
            z-index: 2;
        }

        .hero p {
            position: relative;
            z-index: 2;
        }

        .form-section {
            background: var(--blanc-principal);
            position: relative;
        }

        .form-container {
            background: var(--gris-tres-clair);
            border: 3px solid var(--noir-principal);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .form-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, var(--succes) 0%, var(--noir-principal) 50%, var(--succes) 100%);
        }

        /* Am√©lioration des √©tapes */
        .step-header {
            position: relative;
            padding: var(--space-8) var(--space-6) var(--space-6);
            background: linear-gradient(135deg, var(--blanc-principal) 0%, var(--gris-tres-clair) 100%);
        }

        .step-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 3px;
            background: var(--noir-principal);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .banner-content {
                flex-direction: column;
                gap: var(--space-4);
                text-align: center;
            }

            .banner-price {
                padding: var(--space-2) var(--space-4);
                font-size: var(--text-base);
            }

            .progress-steps {
                grid-template-columns: 1fr;
                gap: var(--space-2);
            }

            .progress-step {
                flex-direction: row;
                justify-content: flex-start;
                text-align: left;
                padding: var(--space-2);
            }

            .step-number {
                margin-right: var(--space-3);
                margin-bottom: 0;
                flex-shrink: 0;
            }

            .interest-grid {
                grid-template-columns: 1fr;
            }

            .step-actions {
                flex-direction: column;
                gap: var(--space-3);
            }

            .step-actions .btn {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            .form-container {
                padding: var(--space-6);
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .step-header h2 {
                font-size: var(--text-xl);
            }

            .banner-text h4 {
                font-size: var(--text-base);
            }
        }
    </style>

    <!-- ========================================
         COMPOSANTS FORNAP
         ======================================== -->
    <script src="../assets/js/config.js"></script>
    <script src="../assets/js/utils.js"></script>
    <script src="../assets/js/auth-service.js"></script>
    <script src="../assets/js/components.js"></script>

    <script>
        // Initialisation des composants FORNAP
        document.addEventListener('DOMContentLoaded', function() {
            console.log('‚úÖ Initialisation composants FORNAP - Profile Setup');

            // Injecter la navbar
            const navbarPlaceholder = document.getElementById('navbar-placeholder');
            if (navbarPlaceholder) {
                navbarPlaceholder.outerHTML = FornapComponents.generateNavbar('profile-setup', '../');
            }

            // Injecter le footer
            const footerPlaceholder = document.getElementById('footer-placeholder');
            if (footerPlaceholder) {
                footerPlaceholder.outerHTML = FornapComponents.generateFooter('../');
            }

            // Initialiser les √©v√©nements apr√®s injection
            setTimeout(() => {
                FornapComponents.initNavbarEvents('../', {
                    onLogin: () => {
                        console.log('Login demand√©');
                    },
                    onLogout: handleLogout
                });
            }, 100);
        });
    </script>
</body>
</html> 