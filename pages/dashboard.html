<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - FORNAP</title>
    
    <!-- CSS -->
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/components.css">
</head>
<body>
    <!-- Placeholder pour la navbar - sera remplac√©e par le composant -->
    <div id="navbar-placeholder"></div>

    <!-- ========================================
         CONTENU PRINCIPAL
         ======================================== -->
    <main class="main-content">
        
        <!-- Header du Dashboard -->
        <section class="dashboard-hero">
            <div class="container">
                <div class="hero-content">
                    <div class="welcome-section">
                        <div class="user-avatar">
                            <span id="userInitials">?</span>
                        </div>
                        <div class="welcome-text">
                            <h1>Bonjour <span id="userFirstName">Membre</span> ! üëã</h1>
                            <p class="subtitle">Bienvenue dans votre espace FORNAP</p>
                        </div>
                    </div>
                    
                    <div class="membership-status">
                        <div class="status-badge" id="membershipBadge">
                            <span class="status-indicator"></span>
                            <span class="status-text">Membre Actif</span>
                        </div>
                        <div class="member-id">
                            <span id="memberNumber">N¬∞ FORNAP-...</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Statistiques rapides -->
        <section class="quick-stats">
            <div class="container">
                <div class="stats-grid">
                    <div class="stat-card loyalty-stat" id="loyaltyStatCard">
                        <div class="stat-icon">‚≠ê</div>
                        <div class="stat-info">
                            <h3 id="loyaltyPoints">0</h3>
                            <p>Points fid√©lit√©</p>
                            <div class="stat-progress" id="loyaltyProgress">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="loyaltyProgressFill"></div>
                                </div>
                                <span class="progress-text" id="loyaltyProgressText"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">üé´</div>
                        <div class="stat-info">
                            <h3 id="eventsCount">0</h3>
                            <p>√âv√©nements particip√©s</p>
                            <span class="stat-detail">Ce mois-ci</span>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">üíº</div>
                        <div class="stat-info">
                            <h3 id="coworkingHours">0h</h3>
                            <p>Coworking utilis√©</p>
                            <span class="stat-detail">Ce mois-ci</span>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">üí∞</div>
                        <div class="stat-info">
                            <h3 id="savingsAmount">0‚Ç¨</h3>
                            <p>√âconomies r√©alis√©es</p>
                            <span class="stat-detail">Avec vos r√©ductions</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Dashboard Principal -->
        <section class="dashboard-main">
            <div class="container">
                <div class="dashboard-layout">
                    
                    <!-- Colonne principale -->
                    <div class="main-column">
                        
                        <!-- Mon abonnement -->
                        <div class="dashboard-card">
                            <div class="card-header">
                                <h3>üé´ Mon Abonnement</h3>
                                <button class="btn btn-secondary btn-small">Modifier</button>
                            </div>
                            <div class="card-content">
                                <div class="subscription-info">
                                    <div class="subscription-plan">
                                        <h4 id="planName">Membre Mensuel</h4>
                                        <p class="plan-price"><span id="planPrice">12‚Ç¨</span><span id="planPeriod">/mois</span></p>
                                    </div>
                                    <div class="subscription-status">
                                        <span class="status active">‚óè Actif</span>
                                        <p class="renewal-date">Renouvellement : <span id="renewalDate">Non d√©fini</span></p>
                                    </div>
                                </div>
                                
                                <div class="subscription-features" id="subscriptionFeatures">
                                    <!-- G√©n√©r√© dynamiquement -->
                                </div>
                            </div>
                        </div>

                        <!-- Programme de fid√©lit√© - Conditionnel -->
                        <div class="dashboard-card" id="loyaltyCard">
                            <div class="card-header">
                                <h3>‚≠ê Programme de Fid√©lit√©</h3>
                                <div class="loyalty-tier" id="loyaltyTier">Bronze</div>
                            </div>
                            <div class="card-content" id="loyaltyContent">
                                <!-- Contenu g√©n√©r√© dynamiquement -->
                            </div>
                        </div>

                        <!-- Activit√© r√©cente -->
                        <div class="dashboard-card">
                            <div class="card-header">
                                <h3>üìà Activit√© R√©cente</h3>
                                <a href="#" class="view-all">Voir tout</a>
                            </div>
                            <div class="card-content">
                                <div class="activity-list" id="activityList">
                                    <div class="activity-item">
                                        <div class="activity-icon">üéØ</div>
                                        <div class="activity-info">
                                            <p><strong>Inscription r√©ussie !</strong></p>
                                            <span class="activity-date">Aujourd'hui</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Colonne secondaire -->
                    <div class="side-column">
                        
                        <!-- Mon profil -->
                        <div class="dashboard-card profile-card">
                            <div class="card-header">
                                <h3>üë§ Mon Profil</h3>
                                <button class="btn btn-secondary btn-small" onclick="editProfile()">Modifier</button>
                            </div>
                            <div class="card-content">
                                <div class="profile-summary" id="profileSummary">
                                    <!-- G√©n√©r√© dynamiquement -->
                                </div>
                            </div>
                        </div>

                        <!-- Prochains √©v√©nements -->
                        <div class="dashboard-card">
                            <div class="card-header">
                                <h3>üéâ Prochains √âv√©nements</h3>
                            </div>
                            <div class="card-content">
                                <div class="event-item">
                                    <div class="event-date">
                                        <span class="day">25</span>
                                        <span class="month">JAN</span>
                                    </div>
                                    <div class="event-info">
                                        <h4>Networking Friday</h4>
                                        <p>18h30 - FORNAP</p>
                                        <span class="event-status available">Places disponibles</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Actions rapides -->
                        <div class="dashboard-card">
                            <div class="card-header">
                                <h3>‚ö° Actions Rapides</h3>
                            </div>
                            <div class="card-content">
                                <div class="quick-actions">
                                    <button class="action-btn">
                                        <span class="action-icon">üè¢</span>
                                        <span>R√©server Coworking</span>
                                    </button>
                                    <button class="action-btn">
                                        <span class="action-icon">üõçÔ∏è</span>
                                        <span>Boutique</span>
                                    </button>
                                    <button class="action-btn">
                                        <span class="action-icon">üé´</span>
                                        <span>√âv√©nements</span>
                                    </button>
                                    <button class="action-btn">
                                        <span class="action-icon">üìû</span>
                                        <span>Support</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Modal de mise √† niveau -->
    <div id="upgradeModal" class="modal hidden">
        <div class="modal-overlay" onclick="closeUpgradeModal()"></div>
        <div class="modal-content">
            <div class="upgrade-content">
                <h3>üöÄ Passez au Membre Annuel !</h3>
                <p>D√©bloquez le programme de fid√©lit√© et bien plus encore :</p>
                <ul>
                    <li>‚≠ê Programme de fid√©lit√© avec r√©compenses</li>
                    <li>üéØ Acc√®s anticip√© aux √©v√©nements</li>
                    <li>üí∞ R√©ductions suppl√©mentaires (-20%)</li>
                    <li>üéÅ Avantages VIP exclusifs</li>
                </ul>
                <div class="upgrade-actions">
                    <button class="btn btn-primary" onclick="upgradeMembership()">
                        Passer √† l'annuel
                    </button>
                    <button class="btn btn-secondary" onclick="closeUpgradeModal()">
                        Plus tard
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Container pour les messages -->
    <div id="messageContainer"></div>

    <!-- Placeholder pour le footer - sera remplac√© par le composant -->
    <div id="footer-placeholder"></div>

    <!-- ========================================
         SCRIPTS FIREBASE
         ======================================== -->
    <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore-compat.js"></script>

    <!-- ========================================
         JAVASCRIPT PRINCIPAL
         ======================================== -->
    <script>
        console.log('üìä FORNAP - Dashboard Membre');

        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyALz161yfiLaOeHU82DQNJV4PkzAXO1wzM",
            authDomain: "nap-7aa80.firebaseapp.com",
            projectId: "nap-7aa80",
            storageBucket: "nap-7aa80.firebasestorage.app",
            messagingSenderId: "434731738248",
            appId: "1:434731738248:web:481644f3a6e809c06d2b3d",
            measurementId: "G-3HVC6HNG02"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        console.log('‚úÖ Firebase initialis√©');

        // Variables globales
        let currentUser = null;
        let memberData = {};

        // Tiers de fid√©lit√©
        const LOYALTY_TIERS = {
            bronze: { name: 'Bronze', min: 0, max: 249, color: '#CD7F32' },
            silver: { name: 'Argent', min: 250, max: 499, color: '#C0C0C0' },
            gold: { name: 'Or', min: 500, max: 999, color: '#FFD700' },
            diamond: { name: 'Diamant', min: 1000, max: Infinity, color: '#B9F2FF' }
        };

        // Fonctions utilitaires
        function showMessage(message, type = 'info') {
            console.log('ÔøΩÔøΩ Message:', message, type);
            
            const container = document.getElementById('messageContainer');
            const messageElement = document.createElement('div');
            messageElement.className = `message ${type}`;
            messageElement.textContent = message;
            container.appendChild(messageElement);

            setTimeout(() => messageElement.classList.add('show'), 100);
            setTimeout(() => {
                messageElement.classList.remove('show');
                setTimeout(() => messageElement.remove(), 300);
            }, 4000);
        }

        function generateInitials(firstName, lastName) {
            const first = firstName ? firstName.charAt(0).toUpperCase() : '';
            const last = lastName ? lastName.charAt(0).toUpperCase() : '';
            return first + last || '?';
        }

        function getCurrentTier(points) {
            for (const [key, tier] of Object.entries(LOYALTY_TIERS)) {
                if (points >= tier.min && points <= tier.max) {
                    return { key, ...tier };
                }
            }
            return { key: 'bronze', ...LOYALTY_TIERS.bronze };
        }

        function getNextTier(currentTierKey) {
            const tiers = ['bronze', 'silver', 'gold', 'diamond'];
            const currentIndex = tiers.indexOf(currentTierKey);
            if (currentIndex < tiers.length - 1) {
                const nextKey = tiers[currentIndex + 1];
                return { key: nextKey, ...LOYALTY_TIERS[nextKey] };
            }
            return null;
        }

        function generateRealisticLoyaltyData() {
            const subscription = memberData.subscription || {};
            let basePoints = 0;
            
            // Points bas√©s sur le type d'abonnement et dur√©e
            const createdAt = memberData.createdAt || new Date();
            const daysSinceJoining = Math.max(1, Math.floor((new Date() - createdAt) / (1000 * 60 * 60 * 24)));
            
            if (subscription.type === 'yearly') {
                // Membres annuels : plus de points car ils sont plus engag√©s
                basePoints = Math.min(400, 50 + (daysSinceJoining * 3)); // 3 points par jour
            } else if (subscription.type === 'honor') {
                // Membres d'honneur : beaucoup de points
                basePoints = Math.min(800, 200 + (daysSinceJoining * 5)); // 5 points par jour
            } else {
                // Membres mensuels : moins de points
                basePoints = Math.min(150, 10 + (daysSinceJoining * 1)); // 1 point par jour
            }
            
            return {
                points: basePoints,
                tier: getCurrentTier(basePoints).key,
                totalEarned: basePoints + Math.floor(basePoints * 0.3), // Quelques points d√©pens√©s
                totalSpent: Math.floor(basePoints * 0.3)
            };
        }

        function generateRealisticUsageData() {
            const subscription = memberData.subscription || {};
            const createdAt = memberData.createdAt || new Date();
            const daysSinceJoining = Math.max(1, Math.floor((new Date() - createdAt) / (1000 * 60 * 60 * 24)));
            const weeksSinceJoining = Math.max(1, Math.floor(daysSinceJoining / 7));
            
            let eventsAttended, coworkingHours, totalVisits;
            
            if (subscription.type === 'yearly') {
                // Membres annuels : plus actifs
                eventsAttended = Math.min(20, Math.floor(weeksSinceJoining * 0.8)); // 0.8 √©v√©nement par semaine
                coworkingHours = Math.min(100, Math.floor(daysSinceJoining * 2)); // 2h par jour en moyenne
                totalVisits = Math.min(50, Math.floor(daysSinceJoining * 0.5)); // 1 visite tous les 2 jours
            } else if (subscription.type === 'honor') {
                // Membres d'honneur : tr√®s actifs
                eventsAttended = Math.min(35, Math.floor(weeksSinceJoining * 1.2)); // 1.2 √©v√©nement par semaine
                coworkingHours = Math.min(200, Math.floor(daysSinceJoining * 3)); // 3h par jour en moyenne
                totalVisits = Math.min(80, Math.floor(daysSinceJoining * 0.8)); // 0.8 visite par jour
            } else {
                // Membres mensuels : mod√©r√©ment actifs
                eventsAttended = Math.min(8, Math.floor(weeksSinceJoining * 0.4)); // 0.4 √©v√©nement par semaine
                coworkingHours = Math.min(40, Math.floor(daysSinceJoining * 0.8)); // 0.8h par jour en moyenne
                totalVisits = Math.min(25, Math.floor(daysSinceJoining * 0.3)); // 1 visite tous les 3 jours
            }
            
            return {
                eventsAttended: eventsAttended,
                coworkingHours: coworkingHours,
                totalVisits: totalVisits,
                thisMonthEvents: Math.min(eventsAttended, Math.floor(Math.random() * 4) + 1),
                thisMonthCoworking: Math.min(coworkingHours, Math.floor(Math.random() * 15) + 5),
                lastVisit: new Date(Date.now() - (Math.random() * 7 * 24 * 60 * 60 * 1000)) // Derni√®re visite dans les 7 derniers jours
            };
        }

        async function loadMemberData() {
            console.log('üìä Chargement des donn√©es membre');

            try {
                if (currentUser) {
                    // R√©cup√©rer depuis Firebase
                    const userDoc = await db.collection('members').doc(currentUser.uid).get();
                    if (userDoc.exists) {
                        memberData = userDoc.data();
                        console.log('üìä Donn√©es Firebase r√©cup√©r√©es:', memberData);
                    } else {
                        console.log('‚ö†Ô∏è Aucune donn√©e Firebase, utilisation des donn√©es locales');
                        // Fallback vers les donn√©es locales
                        loadLocalData();
                    }
                } else {
                    loadLocalData();
                }

                // G√©n√©rer des donn√©es r√©alistes bas√©es sur l'utilisateur et l'abonnement
                if (!memberData.loyalty) {
                    memberData.loyalty = generateRealisticLoyaltyData();
                }

                if (!memberData.usage) {
                    memberData.usage = generateRealisticUsageData();
                }

                updateDashboard();

            } catch (error) {
                console.error('‚ùå Erreur chargement donn√©es:', error);
                showMessage('Erreur lors du chargement des donn√©es', 'error');
                loadLocalData();
                updateDashboard();
            }
        }

        function loadLocalData() {
            // R√©cup√©rer depuis sessionStorage
            const userProfile = sessionStorage.getItem('userProfile');
            const membershipData = sessionStorage.getItem('membershipData');
            const selectedPlan = sessionStorage.getItem('selectedPlan');

            if (userProfile) {
                memberData.profile = JSON.parse(userProfile);
            }

            if (membershipData) {
                memberData.membership = JSON.parse(membershipData);
            }

            if (selectedPlan) {
                const plan = JSON.parse(selectedPlan);
                memberData.subscription = {
                    type: plan.level || 'monthly',
                    name: plan.name || 'Membre Mensuel',
                    amount: plan.amount || plan.price || 12,
                    period: plan.period || '/mois',
                    loyaltyEnabled: plan.loyaltyEnabled || false,
                    features: plan.features || []
                };
            }

            // Donn√©es par d√©faut si rien n'est trouv√©
            if (!memberData.profile) {
                memberData.profile = {
                    firstName: 'Nouveau',
                    lastName: 'Membre',
                    email: currentUser?.email || 'membre@fornap.fr'
                };
            }

            if (!memberData.subscription) {
                memberData.subscription = {
                    type: 'monthly',
                    name: 'Membre Mensuel',
                    amount: 12,
                    period: '/mois',
                    loyaltyEnabled: false,
                    features: ['Acc√®s journ√©e', 'WiFi', 'Espaces communs']
                };
            }
        }

        function updateDashboard() {
            console.log('üîÑ Mise √† jour du dashboard');

            // Header utilisateur
            const firstName = memberData.profile?.firstName || 'Nouveau';
            const lastName = memberData.profile?.lastName || 'Membre';
            
            document.getElementById('userFirstName').textContent = firstName;
            document.getElementById('userInitials').textContent = generateInitials(firstName, lastName);

            // Num√©ro de membre
            const memberNumber = memberData.membership?.number || `FORNAP-${Date.now().toString().slice(-6)}`;
            document.getElementById('memberNumber').textContent = `N¬∞ ${memberNumber}`;

            // Abonnement
            updateSubscriptionInfo();

            // Programme de fid√©lit√© (conditionnel)
            updateLoyaltyProgram();

            // Statistiques
            updateStats();

            // Profil
            updateProfileSummary();

            // Activit√© r√©cente
            updateRecentActivity();
        }

        function updateSubscriptionInfo() {
            const subscription = memberData.subscription || {};
            
            document.getElementById('planName').textContent = subscription.name || 'Membre Mensuel';
            document.getElementById('planPrice').textContent = (subscription.amount || 12) + '‚Ç¨';
            document.getElementById('planPeriod').textContent = subscription.period || '/mois';

            // Date de renouvellement
            const today = new Date();
            const renewalDate = subscription.type === 'yearly' ? 
                new Date(today.getFullYear() + 1, today.getMonth(), today.getDate()) :
                new Date(today.getFullYear(), today.getMonth() + 1, today.getDate());
            
            document.getElementById('renewalDate').textContent = renewalDate.toLocaleDateString('fr-FR');

            // Fonctionnalit√©s
            const featuresContainer = document.getElementById('subscriptionFeatures');
            const features = subscription.features || ['Acc√®s journ√©e', 'WiFi', 'Espaces communs'];
            
            featuresContainer.innerHTML = `
                <h5>Vos avantages :</h5>
                <ul class="features-list">
                    ${features.map(feature => `<li>‚úì ${feature}</li>`).join('')}
                </ul>
            `;
        }

        function updateLoyaltyProgram() {
            const subscription = memberData.subscription || {};
            const loyaltyCard = document.getElementById('loyaltyCard');
            const loyaltyStatCard = document.getElementById('loyaltyStatCard');
            
            // V√©rifier si le programme de fid√©lit√© est accessible
            const hasLoyalty = subscription.loyaltyEnabled || 
                              subscription.type === 'yearly' || 
                              subscription.type === 'honor';

            if (hasLoyalty) {
                // Programme actif
                loyaltyCard.classList.remove('loyalty-disabled');
                loyaltyStatCard.classList.remove('loyalty-disabled');
                
                const points = memberData.loyalty?.points || 0;
                const currentTier = getCurrentTier(points);
                const nextTier = getNextTier(currentTier.key);

                // Mettre √† jour les points
                document.getElementById('loyaltyPoints').textContent = points;
                document.getElementById('loyaltyTier').textContent = currentTier.name;

                // Progression
                if (nextTier) {
                    const progress = ((points - currentTier.min) / (nextTier.min - currentTier.min)) * 100;
                    document.getElementById('loyaltyProgressFill').style.width = `${Math.min(100, progress)}%`;
                    document.getElementById('loyaltyProgressText').textContent = 
                        `${nextTier.min - points} pts pour ${nextTier.name}`;
                } else {
                    document.getElementById('loyaltyProgressFill').style.width = '100%';
                    document.getElementById('loyaltyProgressText').textContent = 'Niveau maximum !';
                }

                // Contenu de la carte fid√©lit√©
                document.getElementById('loyaltyContent').innerHTML = `
                    <div class="loyalty-details">
                        <div class="loyalty-progress-detail">
                            <div class="tier-info">
                                <span class="current-tier">${currentTier.name}</span>
                                <span class="tier-points">${points} points</span>
                            </div>
                            ${nextTier ? `
                                <div class="next-tier-info">
                                    <p>Prochain niveau : <strong>${nextTier.name}</strong></p>
                                    <p class="points-needed">Plus que ${nextTier.min - points} points !</p>
                                </div>
                            ` : `
                                <div class="max-tier-info">
                                    <p>üéâ F√©licitations ! Vous √™tes au niveau maximum !</p>
                                </div>
                            `}
                        </div>
                        
                        <div class="loyalty-rewards">
                            <h5>R√©compenses disponibles :</h5>
                            <div class="rewards-list">
                                <div class="reward-item ${points >= 100 ? 'available' : 'locked'}">
                                    <span class="reward-icon">‚òï</span>
                                    <span class="reward-name">Caf√© gratuit</span>
                                    <span class="reward-cost">100 pts</span>
                                </div>
                                <div class="reward-item ${points >= 250 ? 'available' : 'locked'}">
                                    <span class="reward-icon">üé´</span>
                                    <span class="reward-name">Invit√© gratuit</span>
                                    <span class="reward-cost">250 pts</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

            } else {
                // Programme gris√© pour inciter √† l'upgrade
                loyaltyCard.classList.add('loyalty-disabled');
                loyaltyStatCard.classList.add('loyalty-disabled');
                
                document.getElementById('loyaltyPoints').textContent = '‚Äî';
                document.getElementById('loyaltyProgressText').textContent = 'Passez √† l\'annuel !';
                document.getElementById('loyaltyProgressFill').style.width = '0%';

                document.getElementById('loyaltyContent').innerHTML = `
                    <div class="loyalty-upgrade-prompt">
                        <div class="upgrade-icon">üöÄ</div>
                        <h4>Programme de Fid√©lit√©</h4>
                        <p>Passez au <strong>Membre Annuel</strong> pour d√©bloquer :</p>
                        <ul>
                            <li>‚≠ê Points de fid√©lit√©</li>
                            <li>üéÅ R√©compenses exclusives</li>
                            <li>üí∞ R√©ductions suppl√©mentaires</li>
                            <li>üéØ Acc√®s anticip√© aux √©v√©nements</li>
                        </ul>
                        <button class="btn btn-primary btn-small" onclick="showUpgradeModal()">
                            Passer √† l'annuel
                        </button>
                    </div>
                `;
            }
        }

        function updateStats() {
            const usage = memberData.usage || {};
            const subscription = memberData.subscription || {};
            const loyalty = memberData.loyalty || {};
            
            // √âv√©nements (afficher les √©v√©nements du mois)
            const thisMonthEvents = usage.thisMonthEvents || usage.eventsAttended || 0;
            document.getElementById('eventsCount').textContent = thisMonthEvents;
            
            // Coworking (afficher les heures du mois)
            const thisMonthCoworking = usage.thisMonthCoworking || Math.min(usage.coworkingHours || 0, 20);
            document.getElementById('coworkingHours').textContent = thisMonthCoworking + 'h';
            
            // √âconomies r√©alistes bas√©es sur l'utilisation r√©elle
            const discount = subscription.type === 'yearly' ? 0.2 : subscription.type === 'honor' ? 0.25 : 0.1;
            const avgSpendingPerVisit = 15; // Moyenne r√©aliste par visite (caf√©, snacks, etc.)
            const totalSavings = Math.floor(avgSpendingPerVisit * discount * (usage.totalVisits || 1));
            document.getElementById('savingsAmount').textContent = totalSavings + '‚Ç¨';
        }

        function updateProfileSummary() {
            const profile = memberData.profile || {};
            
            document.getElementById('profileSummary').innerHTML = `
                <div class="profile-info">
                    <p><strong>${profile.firstName || 'Pr√©nom'} ${profile.lastName || 'Nom'}</strong></p>
                    <p class="profile-email">${profile.email || 'Email non renseign√©'}</p>
                    ${profile.phone ? `<p class="profile-phone">${profile.phone}</p>` : ''}
                    ${profile.profession ? `<p class="profile-profession">${profile.profession}</p>` : ''}
                    ${profile.company ? `<p class="profile-company">${profile.company}</p>` : ''}
                </div>
            `;
        }

        function updateRecentActivity() {
            const usage = memberData.usage || {};
            const subscription = memberData.subscription || {};
            const profile = memberData.profile || {};
            
            const activities = [];
            
            // Activit√© d'inscription
            activities.push({
                icon: 'üéØ',
                text: `Inscription r√©ussie en tant que ${subscription.name || 'Membre FORNAP'} !`,
                date: 'Aujourd\'hui'
            });
            
            // Activit√© bas√©e sur les donn√©es d'utilisation
            if (usage.eventsAttended > 0) {
                activities.push({
                    icon: 'üé´',
                    text: `Participation √† ${usage.eventsAttended} √©v√©nement${usage.eventsAttended > 1 ? 's' : ''}`,
                    date: 'Cette semaine'
                });
            }
            
            if (usage.coworkingHours > 0) {
                activities.push({
                    icon: 'üíº',
                    text: `${usage.coworkingHours}h de coworking utilis√©es`,
                    date: 'Ce mois-ci'
                });
            }
            
            if (subscription.type === 'yearly' || subscription.type === 'honor') {
                activities.push({
                    icon: '‚≠ê',
                    text: 'Programme de fid√©lit√© activ√©',
                    date: '√Ä l\'inscription'
                });
            }
            
            // Si peu d'activit√©s, ajouter des suggestions
            if (activities.length < 3) {
                activities.push({
                    icon: 'üöÄ',
                    text: 'R√©servez votre premier espace coworking',
                    date: 'Suggestion',
                    suggestion: true
                });
            }
            
            const activityList = document.getElementById('activityList');
            activityList.innerHTML = activities.map(activity => `
                <div class="activity-item ${activity.suggestion ? 'activity-suggestion' : ''}">
                    <div class="activity-icon">${activity.icon}</div>
                    <div class="activity-info">
                        <p><strong>${activity.text}</strong></p>
                        <span class="activity-date">${activity.date}</span>
                    </div>
                </div>
            `).join('');
        }

        function showUpgradeModal() {
            document.getElementById('upgradeModal').classList.remove('hidden');
        }

        function closeUpgradeModal() {
            document.getElementById('upgradeModal').classList.add('hidden');
        }

        function upgradeMembership() {
            showMessage('Redirection vers la mise √† niveau...', 'info');
            setTimeout(() => {
                window.location.href = '../pages/membership.html';
            }, 1000);
        }

        function editProfile() {
            showMessage('Redirection vers l\'√©dition du profil...', 'info');
            setTimeout(() => {
                window.location.href = 'profile-setup.html';
            }, 1000);
        }

        async function handleLogout() {
            try {
                await auth.signOut();
                console.log('‚úÖ D√©connexion r√©ussie');
                showMessage('D√©connexion r√©ussie', 'success');
                
                sessionStorage.clear();
                
                setTimeout(() => {
                    window.location.href = '../index.html';
                }, 1500);
                
            } catch (error) {
                console.error('‚ùå Erreur d√©connexion:', error);
                showMessage('Erreur lors de la d√©connexion', 'error');
            }
        }

        // Gestion de l'authentification
        auth.onAuthStateChanged(function(user) {
            console.log('Changement √©tat auth:', user ? user.email : 'd√©connect√©');
            currentUser = user;
            
            if (!user) {
                console.log('‚ö†Ô∏è Utilisateur non connect√©');
                showMessage('Session expir√©e. Redirection...', 'warning');
                setTimeout(() => window.location.href = '../index.html', 3000);
            } else {
                loadMemberData();
            }
        });

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            console.log('‚úÖ DOM charg√© - Dashboard');
        });
    </script>

    <style>
        /* ========================================
           STYLES DASHBOARD MODERNE
           ======================================== */
        
        /* Hero Dashboard */
        .dashboard-hero {
            background: linear-gradient(135deg, var(--noir-principal) 0%, #333 100%);
            color: var(--blanc-principal);
            padding: var(--space-8) 0;
            margin-top: -32px; /* Compenser le padding du main-content */
        }

        .hero-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: var(--space-6);
        }

        .welcome-section {
            display: flex;
            align-items: center;
            gap: var(--space-4);
        }

        .user-avatar {
            width: 60px;
            height: 60px;
            background: var(--blanc-principal);
            color: var(--noir-principal);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--text-xl);
            font-weight: var(--font-bold);
        }

        .welcome-text h1 {
            font-size: var(--text-3xl);
            margin-bottom: var(--space-2);
            color: var(--blanc-principal);
        }

        .subtitle {
            color: #ccc;
            font-size: var(--text-lg);
        }

        .membership-status {
            text-align: right;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            background: rgba(255, 255, 255, 0.1);
            padding: var(--space-2) var(--space-4);
            margin-bottom: var(--space-2);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--succes);
        }

        .member-id {
            font-size: var(--text-sm);
            color: #ccc;
        }

        /* Statistiques rapides */
        .quick-stats {
            padding: var(--space-8) 0;
            background: var(--gris-tres-clair);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-6);
        }

        .stat-card {
            background: var(--blanc-principal);
            border: 2px solid var(--noir-principal);
            padding: var(--space-6);
            display: flex;
            align-items: center;
            gap: var(--space-4);
            transition: var(--transition-base);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .stat-card.loyalty-disabled {
            opacity: 0.6;
            background: #f8f9fa;
            border-color: #ccc;
        }

        .stat-icon {
            font-size: var(--text-3xl);
            flex-shrink: 0;
        }

        .stat-info h3 {
            font-size: var(--text-2xl);
            font-weight: var(--font-bold);
            margin-bottom: var(--space-1);
            color: var(--noir-principal);
        }

        .stat-info p {
            color: var(--gris-moyen);
            font-weight: var(--font-medium);
            margin-bottom: var(--space-2);
        }

        .stat-detail {
            font-size: var(--text-sm);
            color: var(--gris-moyen);
        }

        .stat-progress {
            margin-top: var(--space-3);
        }

        .progress-bar {
            height: 4px;
            background: var(--gris-clair);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: var(--space-2);
        }

        .progress-fill {
            height: 100%;
            background: var(--noir-principal);
            transition: width 0.5s ease;
        }

        .progress-text {
            font-size: var(--text-xs);
            color: var(--gris-moyen);
        }

        /* Layout principal */
        .dashboard-main {
            padding: var(--space-8) 0;
        }

        .dashboard-layout {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: var(--space-8);
        }

        /* Cards */
        .dashboard-card {
            background: var(--blanc-principal);
            border: 2px solid var(--noir-principal);
            margin-bottom: var(--space-6);
            transition: var(--transition-base);
        }

        .dashboard-card:hover {
            box-shadow: var(--shadow-md);
        }

        .dashboard-card.loyalty-disabled {
            border-color: #ccc;
            background: #f8f9fa;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-6);
            border-bottom: 2px solid var(--noir-principal);
            background: var(--gris-tres-clair);
        }

        .loyalty-disabled .card-header {
            border-bottom-color: #ccc;
            background: #e9ecef;
        }

        .card-header h3 {
            font-size: var(--text-lg);
            font-weight: var(--font-bold);
            color: var(--noir-principal);
        }

        .loyalty-disabled .card-header h3 {
            color: #666;
        }

        .card-content {
            padding: var(--space-6);
        }

        /* Abonnement */
        .subscription-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-6);
            margin-bottom: var(--space-6);
        }

        .subscription-plan h4 {
            font-size: var(--text-xl);
            margin-bottom: var(--space-2);
            color: var(--noir-principal);
        }

        .plan-price {
            font-size: var(--text-lg);
            font-weight: var(--font-bold);
            color: var(--noir-principal);
        }

        .subscription-status {
            text-align: right;
        }

        .status.active {
            color: var(--succes);
            font-weight: var(--font-bold);
        }

        .renewal-date {
            font-size: var(--text-sm);
            color: var(--gris-moyen);
            margin-top: var(--space-2);
        }

        .features-list {
            list-style: none;
            margin-top: var(--space-4);
        }

        .features-list li {
            padding: var(--space-2) 0;
            color: var(--gris-moyen);
            border-bottom: 1px solid var(--gris-clair);
        }

        /* Programme de fid√©lit√© */
        .loyalty-tier {
            background: var(--noir-principal);
            color: var(--blanc-principal);
            padding: var(--space-2) var(--space-4);
            font-size: var(--text-sm);
            font-weight: var(--font-bold);
        }

        .loyalty-disabled .loyalty-tier {
            background: #ccc;
        }

        .loyalty-upgrade-prompt {
            text-align: center;
        }

        .upgrade-icon {
            font-size: var(--text-4xl);
            margin-bottom: var(--space-4);
        }

        .loyalty-upgrade-prompt h4 {
            margin-bottom: var(--space-3);
            color: var(--gris-moyen);
        }

        .loyalty-upgrade-prompt ul {
            text-align: left;
            margin: var(--space-4) 0;
            color: var(--gris-moyen);
        }

        .loyalty-details {
            display: grid;
            gap: var(--space-6);
        }

        .tier-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-4);
        }

        .current-tier {
            font-weight: var(--font-bold);
            font-size: var(--text-lg);
        }

        .tier-points {
            font-size: var(--text-sm);
            color: var(--gris-moyen);
        }

        .next-tier-info, .max-tier-info {
            background: var(--gris-tres-clair);
            padding: var(--space-4);
            border-left: 4px solid var(--noir-principal);
        }

        .points-needed {
            font-size: var(--text-sm);
            color: var(--gris-moyen);
        }

        .rewards-list {
            display: grid;
            gap: var(--space-3);
            margin-top: var(--space-4);
        }

        .reward-item {
            display: grid;
            grid-template-columns: auto 1fr auto;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3);
            border: 1px solid var(--gris-clair);
            transition: var(--transition-base);
        }

        .reward-item.available {
            border-color: var(--succes);
            background: rgba(40, 167, 69, 0.05);
        }

        .reward-item.locked {
            opacity: 0.5;
        }

        .reward-cost {
            font-size: var(--text-sm);
            font-weight: var(--font-bold);
            color: var(--gris-moyen);
        }

        /* Profil */
        .profile-info p {
            margin-bottom: var(--space-2);
            padding-bottom: var(--space-2);
            border-bottom: 1px solid var(--gris-clair);
        }

        .profile-info p:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .profile-email {
            color: var(--gris-moyen);
            font-size: var(--text-sm);
        }

        .profile-phone, .profile-profession, .profile-company {
            color: var(--gris-moyen);
            font-size: var(--text-sm);
        }

        /* √âv√©nements */
        .event-item {
            display: flex;
            gap: var(--space-4);
            align-items: center;
        }

        .event-date {
            text-align: center;
            min-width: 60px;
        }

        .event-date .day {
            display: block;
            font-size: var(--text-xl);
            font-weight: var(--font-bold);
            color: var(--noir-principal);
        }

        .event-date .month {
            display: block;
            font-size: var(--text-sm);
            color: var(--gris-moyen);
        }

        .event-info h4 {
            margin-bottom: var(--space-1);
            color: var(--noir-principal);
        }

        .event-info p {
            color: var(--gris-moyen);
            margin-bottom: var(--space-2);
        }

        .event-status.available {
            color: var(--succes);
            font-size: var(--text-sm);
            font-weight: var(--font-bold);
        }

        /* Actions rapides */
        .quick-actions {
            display: grid;
            gap: var(--space-3);
        }

        .action-btn {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            width: 100%;
            padding: var(--space-4);
            background: var(--blanc-principal);
            border: 2px solid var(--gris-clair);
            color: var(--noir-principal);
            cursor: pointer;
            transition: var(--transition-base);
            font-size: var(--text-base);
        }

        .action-btn:hover {
            border-color: var(--noir-principal);
            background: var(--gris-tres-clair);
        }

        .action-icon {
            font-size: var(--text-lg);
        }

        /* Activit√© */
        .activity-list {
            display: grid;
            gap: var(--space-4);
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: var(--space-4);
            padding: var(--space-4);
            background: var(--gris-tres-clair);
            border-left: 4px solid var(--noir-principal);
        }

        .activity-icon {
            font-size: var(--text-lg);
            flex-shrink: 0;
        }

        .activity-info p {
            margin-bottom: var(--space-1);
        }

        .activity-date {
            font-size: var(--text-sm);
            color: var(--gris-moyen);
        }

        .activity-suggestion {
            border-left-color: var(--attention) !important;
            background: rgba(255, 193, 7, 0.05);
        }

        .activity-suggestion .activity-icon {
            opacity: 0.7;
        }

        /* Modal de mise √† niveau */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
        }

        .modal-content {
            position: relative;
            background: var(--blanc-principal);
            border: 2px solid var(--noir-principal);
            padding: var(--space-8);
            max-width: 500px;
            width: 90%;
            box-shadow: var(--shadow-lg);
        }

        .upgrade-content h3 {
            margin-bottom: var(--space-4);
            color: var(--noir-principal);
        }

        .upgrade-content ul {
            margin: var(--space-4) 0;
            color: var(--gris-moyen);
        }

        .upgrade-actions {
            display: flex;
            gap: var(--space-4);
            justify-content: center;
            margin-top: var(--space-6);
        }

        /* Utilitaires */
        .view-all {
            color: var(--noir-principal);
            text-decoration: none;
            font-size: var(--text-sm);
            font-weight: var(--font-medium);
        }

        .view-all:hover {
            text-decoration: underline;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .hero-content {
                flex-direction: column;
                text-align: center;
                gap: var(--space-4);
            }

            .membership-status {
                text-align: center;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .dashboard-layout {
                grid-template-columns: 1fr;
                gap: var(--space-6);
            }

            .subscription-info {
                grid-template-columns: 1fr;
                text-align: center;
            }

            .subscription-status {
                text-align: center;
            }

            .card-header {
                flex-direction: column;
                gap: var(--space-3);
                text-align: center;
            }
        }

        @media (max-width: 480px) {
            .dashboard-hero {
                padding: var(--space-6) 0;
            }

            .welcome-text h1 {
                font-size: var(--text-2xl);
            }

            .user-avatar {
                width: 50px;
                height: 50px;
                font-size: var(--text-lg);
            }

            .stat-card {
                flex-direction: column;
                text-align: center;
                gap: var(--space-3);
            }

            .modal-content {
                padding: var(--space-6);
            }

            .upgrade-actions {
                flex-direction: column;
            }
        }
    </style>

    <!-- ========================================
         SCRIPTS FIREBASE
         ======================================== -->
    <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore-compat.js"></script>
    
    <!-- ========================================
         MODULES FORNAP
         ======================================== -->
    <script src="../assets/js/config.js"></script>
    <script src="../assets/js/utils.js"></script>
    <script src="../assets/js/auth-service.js"></script>
    <script src="../assets/js/components.js"></script>

    <script>
        // Initialisation des composants FORNAP pour la page dashboard
        document.addEventListener('DOMContentLoaded', function() {
            console.log('‚úÖ Initialisation composants FORNAP - Dashboard');

            // Injecter la navbar avec le bon basePath
            const navbarPlaceholder = document.getElementById('navbar-placeholder');
            if (navbarPlaceholder) {
                navbarPlaceholder.outerHTML = FornapComponents.generateNavbar('dashboard', '../');
            }

            // Injecter le footer
            const footerPlaceholder = document.getElementById('footer-placeholder');
            if (footerPlaceholder) {
                footerPlaceholder.outerHTML = FornapComponents.generateFooter('../');
            }

            // Initialiser les √©v√©nements apr√®s injection
            setTimeout(() => {
                FornapComponents.initNavbarEvents('../', {
                    onLogin: () => {
                        console.log('Login demand√© (d√©j√† connect√©)');
                    },
                    onLogout: handleLogout
                });
            }, 100);
        });
    </script>
</body>
</html> 